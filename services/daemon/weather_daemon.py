#!/usr/bin/env python3
"""
ClearyFi Weather Notification Daemon
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ–≥–æ–¥–µ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.
"""

import sys
import os
import time
import logging
import traceback
from typing import Dict, List, Tuple, Optional

# =============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–£–¢–ï–ô –ò –ò–ú–ü–û–†–¢–û–í
# =============================================================================

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
PROJECT_ROOT = "/data/data/com.termux/files/home/projects/clearyfi"
sys.path.insert(0, PROJECT_ROOT)

print(f"üöÄ –î–µ–º–æ–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
print(f"üìÅ PROJECT_ROOT: {PROJECT_ROOT}")
print(f"üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {os.getcwd()}")

try:
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏
    from services.storage.subscriber_db import SubscriberDBConnection
    from services.weather.weather_api_client import WeatherAPIClient
    from core.weather_analyzer import WeatherAnalyzer
    import telebot
    from config.settings import settings
    from services.daemon.daemon_manager import DaemonManager
    
    print("‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!")
    
except ImportError as e:
    print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    print(f"üîç –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:")
    traceback.print_exc()
    sys.exit(1)

# =============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø
# =============================================================================

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s ‚Äî %(levelname)s ‚Äî %(message)s",
    handlers=[
        logging.FileHandler("weather_daemon.log"),  # –õ–æ–≥–∏ –≤ —Ñ–∞–π–ª
        logging.StreamHandler()  # –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—å
    ]
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram –±–æ—Ç–∞
bot = telebot.TeleBot(settings.TELEGRAM_BOT_TOKEN)

# =============================================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# =============================================================================

def translate_weather_conditions(conditions: List[str]) -> str:
    """
    –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–≥–æ–¥–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.
    
    Args:
        conditions: –°–ø–∏—Å–æ–∫ –ø–æ–≥–æ–¥–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –æ—Ç API (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º)
        
    Returns:
        –°—Ç—Ä–æ–∫–∞ —Å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º —É—Å–ª–æ–≤–∏–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
    """
    translation_map = {
        'Clear': '–Ø—Å–Ω–æ',
        'Clouds': '–û–±–ª–∞—á–Ω–æ',
        'Rain': '–î–æ–∂–¥—å',
        'Drizzle': '–ú–æ—Ä–æ—Å—å',
        'Thunderstorm': '–ì—Ä–æ–∑–∞',
        'Snow': '–°–Ω–µ–≥',
        'Mist': '–¢—É–º–∞–Ω',
        'Fog': '–¢—É–º–∞–Ω',
        'Haze': '–î—ã–º–∫–∞'
    }
    
    translated = []
    for condition in conditions:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–≤–æ–¥ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ –æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
        translated_condition = translation_map.get(condition, condition)
        translated.append(translated_condition)
    
    return ', '.join(translated) if translated else '–Ø—Å–Ω–æ'


def get_day_name(date_str: str) -> str:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
    
    Args:
        date_str: –°—Ç—Ä–æ–∫–∞ —Å –¥–∞—Ç–æ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î
        
    Returns:
        –ù–∞–∑–≤–∞–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
    """
    days_mapping = {
        'Monday': '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
        'Tuesday': '–í—Ç–æ—Ä–Ω–∏–∫', 
        'Wednesday': '–°—Ä–µ–¥–∞',
        'Thursday': '–ß–µ—Ç–≤–µ—Ä–≥',
        'Friday': '–ü—è—Ç–Ω–∏—Ü–∞',
        'Saturday': '–°—É–±–±–æ—Ç–∞',
        'Sunday': '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
    }
    
    try:
        from datetime import datetime
        # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏–∑ —Å—Ç—Ä–æ–∫–∏
        date_obj = datetime.strptime(date_str, '%Y-%m-%d')
        # –ü–æ–ª—É—á–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
        english_day = date_obj.strftime('%A')
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
        return days_mapping.get(english_day, date_str)
    except (ValueError, TypeError) as e:
        logging.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã '{date_str}': {e}")
        return date_str


def get_wash_recommendation(day_data: Dict) -> Tuple[str, str]:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ –º–æ–π–∫–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    
    Args:
        day_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ–≥–æ–¥–µ –∑–∞ –¥–µ–Ω—å
        
    Returns:
        –ö–æ—Ä—Ç–µ–∂ (—ç–º–æ–¥–∑–∏-—Å—Ç–∞—Ç—É—Å, —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)
    """
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ—Ç–µ–æ–ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    temp = day_data.get('temp', 0)
    rain_prob = day_data.get('rain_prob', 0)
    humidity = day_data.get('humidity', 0)
    wind = day_data.get('wind', 0)
    
    # –ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò –î–õ–Ø –ú–û–ô–ö–ò:
    
    # 1. –ò–¥–µ–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è: –Ω–µ—Ç –æ—Å–∞–¥–∫–æ–≤, —Ç–µ–ø–ª–æ, –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å, —Å–ª–∞–±—ã–π –≤–µ—Ç–µ—Ä
    if rain_prob == 0 and temp > 5 and humidity < 80 and wind < 8:
        return "‚úÖ", "–û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –º–æ–π–∫–∏"
    
    # 2. –•–æ—Ä–æ—à–∏–µ —É—Å–ª–æ–≤–∏—è: –Ω–µ—Ç –æ—Å–∞–¥–∫–æ–≤, –Ω–æ –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ
    elif rain_prob == 0 and temp > 0 and humidity < 85:
        return "‚ö†Ô∏è", "–ú–æ–∂–Ω–æ –ø–æ–º—ã—Ç—å, –Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ"
    
    # 3. –ü–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è - –æ—Å–∞–¥–∫–∏ (—Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä)
    elif rain_prob > 0:
        return "‚ùå", "–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –æ–∂–∏–¥–∞—é—Ç—Å—è –æ—Å–∞–¥–∫–∏"
    
    # 4. –ü–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è - –º–æ—Ä–æ–∑ (—Ä–∏—Å–∫ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –ª—å–¥–∞)
    elif temp <= 0:
        return "‚ùå", "–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –≤–æ–∑–º–æ–∂–µ–Ω –ª–µ–¥"
    
    # 5. –ü–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è - —Å–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä (–±—ã—Å—Ç—Ä–æ–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ)
    elif wind >= 8:
        return "‚ùå", "–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: —Å–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä"
    
    # 6. –ü–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è - –≤—ã—Å–æ–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å (–º–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—ã—Å—ã—Ö–∞–Ω–∏–µ)
    elif humidity >= 85:
        return "‚ùå", "–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –≤—ã—Å–æ–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å"
    
    # 7. –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏
    else:
        return "‚ö†Ô∏è", "–£—Å–ª–æ–≤–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º–æ–π–∫–∏"


def get_weather_tips(days_forecast: List[Dict]) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è –∞–≤—Ç–æ–≤–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ–≥–æ–¥—ã.
    
    Args:
        days_forecast: –°–ø–∏—Å–æ–∫ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π
        
    Returns:
        –°—Ç—Ä–æ–∫–∞ —Å —Å–æ–≤–µ—Ç–∞–º–∏ –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ —Å–æ–≤–µ—Ç–æ–≤ –Ω–µ—Ç
    """
    tips = []
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω 1: –î–æ–∂–¥–ª–∏–≤—ã–µ –¥–Ω–∏
    rainy_days = [day for day in days_forecast if day.get('rain_prob', 0) > 0]
    if rainy_days:
        tips.append("üåßÔ∏è *–°–æ–≤–µ—Ç:* –í –¥–æ–∂–¥–ª–∏–≤—ã–µ –¥–Ω–∏ –º–æ–π–∫—É –ª—É—á—à–µ –æ—Ç–ª–æ–∂–∏—Ç—å")
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω 2: –ú–æ—Ä–æ–∑–Ω—ã–µ –¥–Ω–∏
    cold_days = [day for day in days_forecast if day.get('temp', 0) <= 0]
    if cold_days:
        tips.append("üßä *–°–æ–≤–µ—Ç:* –ü—Ä–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –Ω–∏–∂–µ 0¬∞C –≤–æ–∑–º–æ–∂–µ–Ω –≥–æ–ª–æ–ª–µ–¥")
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω 3: –í–µ—Ç—Ä–µ–Ω—ã–µ –¥–Ω–∏
    windy_days = [day for day in days_forecast if day.get('wind', 0) >= 8]
    if windy_days:
        tips.append("üí® *–°–æ–≤–µ—Ç:* –í –≤–µ—Ç—Ä–µ–Ω—É—é –ø–æ–≥–æ–¥—É –Ω–∞ –º–∞—à–∏–Ω—É –±—ã—Å—Ç—Ä–æ —Å–∞–¥–∏—Ç—Å—è –ø—ã–ª—å")
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω 4: –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    good_days = [day for day in days_forecast if day.get('rain_prob', 0) == 0 and day.get('temp', 0) > 5]
    if len(good_days) >= 2:
        tips.append("üëç *–°–æ–≤–µ—Ç:* –û—Ç–ª–∏—á–Ω–∞—è –Ω–µ–¥–µ–ª—è –¥–ª—è —É—Ö–æ–¥–∞ –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º!")
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–≤–µ—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if tips:
        tips_text = "üí° *–ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã:*\n" + "\n".join(f"‚Ä¢ {tip}" for tip in tips) + "\n\n"
        return tips_text
    else:
        return ""


# =============================================================================
# –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–ï–ú–û–ù–ê
# =============================================================================

def send_recommendation(chat_id: int, city: str) -> bool:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–≥–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    
    Args:
        chat_id: ID —á–∞—Ç–∞ –≤ Telegram
        city: –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞
        
    Returns:
        True –µ—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ, False –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    try:
        logging.info(f"üì® –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è {city} (chat_id: {chat_id})")

        # –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –æ—Ç API
        weather_client = WeatherAPIClient(api_key=settings.OPENWEATHER_API_KEY)
        forecast = weather_client.get_forecast(city, days=3)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        if not forecast:
            logging.warning(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è {city}")
            return False

        if "list" not in forecast:
            logging.warning(f"‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è {city}")
            return False

        # –®–ê–ì 2: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        analyzer = WeatherAnalyzer(forecast)
        daily_summary = analyzer.get_daily_summary()
        
        # –®–ê–ì 3: –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        
        # 3.1 –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        message = "üöó *ClearyFi - –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç*\n\n"
        message += f"üìç *–ì–æ—Ä–æ–¥:* {city}\n\n"
        
        # 3.2 –ì–ª–∞–≤–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (—Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –≤ –Ω–∞—á–∞–ª–µ)
        best_day = analyzer.get_best_wash_day()
        if best_day:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ (–î–î.–ú–ú)
            date_parts = best_day['date'].split('-')
            formatted_date = f"{date_parts[2]}.{date_parts[1]}"
            
            message += "‚úÖ *–†–ï–ö–û–ú–ï–ù–î–£–ï–ú –ü–û–ú–´–¢–¨ –ê–í–¢–û:*\n"
            message += f"üìÖ *–ö–æ–≥–¥–∞:* {formatted_date} ({get_day_name(best_day['date'])})\n"
            message += f"üå° *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:* {best_day['temp']:.0f}¬∞C\n"
            message += f"üíß *–í–ª–∞–∂–Ω–æ—Å—Ç—å:* {best_day['humidity']:.0f}%\n"
            message += f"üí® *–í–µ—Ç–µ—Ä:* {best_day['wind']:.1f} –º/—Å\n"
            message += f"‚òÅÔ∏è *–ü–æ–≥–æ–¥–∞:* {translate_weather_conditions(best_day['conditions'])}\n\n"
        else:
            message += "‚ö†Ô∏è *–í–Ω–∏–º–∞–Ω–∏–µ:* –ò–¥–µ–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π –¥–ª—è –º–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ\n\n"
        
        # 3.3 –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ –¥–Ω—è–º
        message += "üìä *–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—è:*\n\n"
        
        for i, day in enumerate(daily_summary[:3]):
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
            date_parts = day['date'].split('-')
            formatted_date = f"{date_parts[2]}.{date_parts[1]}"
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –¥–ª—è –¥–Ω—è
            wash_status, wash_description = get_wash_recommendation(day)
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –¥–Ω—è (–°–µ–≥–æ–¥–Ω—è/–ó–∞–≤—Ç—Ä–∞/–ù–∞–∑–≤–∞–Ω–∏–µ –¥–Ω—è)
            day_name = get_day_name(day['date'])
            if i == 0:
                day_label = "–°–µ–≥–æ–¥–Ω—è"
            elif i == 1:
                day_label = "–ó–∞–≤—Ç—Ä–∞" 
            else:
                day_label = day_name
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –±–ª–æ–∫ –¥–Ω—è
            message += f"{wash_status} *{day_label} ({formatted_date})*\n"
            message += f"   {wash_description}\n"
            message += f"   üå° {day['temp']:.0f}¬∞C | üíß {day['humidity']:.0f}% | üí® {day['wind']:.1f} –º/—Å\n"
            message += f"   ‚òÅÔ∏è {translate_weather_conditions(day['conditions'])}\n\n"

        # 3.4 –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
        message += get_weather_tips(daily_summary[:3])
        
        # 3.5 –ü–æ–¥–ø–∏—Å—å
        message += "\n---\n"
        message += "üöó *ClearyFi* - —É–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ"

        # –®–ê–ì 4: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        bot.send_message(
            chat_id,
            message,
            parse_mode='Markdown'
        )

        logging.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è {city}")
        return True

    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è {city}: {e}")
        logging.debug(traceback.format_exc())
        return False


def run_daemon():
    """
    –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –¥–µ–º–æ–Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
    
    –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –∫–æ—Ç–æ—Ä—ã–π:
    1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
    2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    3. –û–∂–∏–¥–∞–µ—Ç –∑–∞–¥–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
    4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
    """
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–µ–º–æ–Ω–∞
        DaemonManager.init_settings()
        logging.info("üöÄ –î–µ–º–æ–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–ø—É—â–µ–Ω!")

        # –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—á–∏–π —Ü–∏–∫–ª
        while True:
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ (–≤ —á–∞—Å–∞—Ö)
            interval_hours = DaemonManager.get_interval()
            logging.info(f"üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤...")
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
            with SubscriberDBConnection() as db:
                users = db.get_all_active_users()
                
            logging.info(f"üìã –ù–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: {len(users)}")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∂–¥–æ–º—É –ø–æ–¥–ø–∏—Å—á–∏–∫—É
            success_count = 0
            for user in users:
                try:
                    if send_recommendation(user["chat_id"], user["city"]):
                        success_count += 1
                    # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã Telegram API
                    time.sleep(1)
                except Exception as e:
                    logging.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user}: {e}")
                    continue
            
            # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Ç–µ—Ä–∞—Ü–∏–∏
            logging.info(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {success_count}/{len(users)}")
            logging.info(f"‚è≥ –°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ {interval_hours} —á–∞—Å–æ–≤")
            
            # –û–∂–∏–¥–∞–µ–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ø–µ—Ä–µ–≤–æ–¥–∏–º —á–∞—Å—ã –≤ —Å–µ–∫—É–Ω–¥—ã)
            time.sleep(interval_hours * 3600)
            
    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ - –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
        logging.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –¥–µ–º–æ–Ω–µ: {e}")
        logging.debug(traceback.format_exc())
        logging.info("üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç...")
        time.sleep(300)  # 5 –º–∏–Ω—É—Ç


# =============================================================================
# –¢–û–ß–ö–ê –í–•–û–î–ê
# =============================================================================

if __name__ == "__main__":
    """
    –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é.
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –¥–µ–º–æ–Ω–∞.
    """
    run_daemon()
